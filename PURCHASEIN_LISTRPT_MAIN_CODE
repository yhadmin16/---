SELECT BMV.CODE MCODE,
       BMV.NAME MATERIAL,
       IPIB.PK_GROUP,
       NVL(IPIB.NNUM, 0) NNUM,
       NVL(IPIB.NORIGTAXPRICE, 0) PRICE,
       NVL(IPIB.NNUM, 0) * NVL(IPIB.NORIGTAXPRICE, 0) TOTALMONEY,
       IPIB.VBDEF2 CARNO,
       IPIB.VBDEF3 GUIHAO,
       CASE
         WHEN (NVL(IPIB.VBDEF1, 0) = '~') THEN
          0
         ELSE
          TO_NUMBER(IPIB.VBDEF1)
       END SUPPWEIGHT,
       BSD.NAME STORENAME,
       SUBSTR(IPIB.DBIZDATE, 1, 4) RKYEAR,
       SUBSTR(IPIB.DBIZDATE, 6, 2) RKMONTH,
       SUBSTR(IPIB.DBIZDATE, 9, 2) RKDAY,
       PAO.VDEF1 CONTRACTNO,
       SUBSTR(IPIB.DBIZDATE, 1, 10) RKDATE,
       BSUP.NAME SUPPLIER,
       OSO.NAME ORGNAME,
       OFO.NAME FINNAME,
       PSBB.TRANSPORTATIONCOST TRANSPORTATIONCOST,
       PIB.VBDEF2 DEDUCTMONEY,
       LMVO.NETWEIGHT NETWEIGHT,
       LMVO.FINALNETWEIGHT FINALNETWEIGHT
  FROM IC_PURCHASEIN_B IPIB
  LEFT JOIN IC_PURCHASEIN_H IPIH
    ON IPIB.CGENERALHID = IPIH.CGENERALHID
  LEFT JOIN BD_SUPPLIER BSUP
    ON IPIH.CVENDORID = BSUP.PK_SUPPLIER
  LEFT JOIN BD_MATERIAL_V BMV
    ON IPIB.CMATERIALVID = BMV.PK_SOURCE
  LEFT JOIN ORG_STOCKORG OSO
    ON IPIH.PK_ORG = OSO.PK_STOCKORG
  LEFT JOIN ORG_FINANCEORG OFO
    ON IPIB.CFANACEORGOID = OFO.PK_FINANCEORG
  LEFT JOIN BD_STORDOC BSD
    ON IPIH.CWAREHOUSEID = BSD.PK_STORDOC
  LEFT JOIN BD_MARBASCLASS BMC
    ON BMV.PK_MARBASCLASS = BMC.PK_MARBASCLASS
  LEFT JOIN (SELECT SUM(TO_NUMBER(NVL(PSBB_A.NCOSTFACTOR1, 0))) TRANSPORTATIONCOST,
                    PSBB_A.PK_PURCHASEIN_B
               FROM PO_SETTLEBILL_B PSBB_A
              WHERE PSBB_A.DR = 0
              GROUP BY PSBB_A.PK_PURCHASEIN_B) PSBB
    ON IPIB.CGENERALBID = PSBB.PK_PURCHASEIN_B
  LEFT JOIN (SELECT SUM(CASE
                          WHEN (NVL(PIB_A.VBDEF2, 0) = '~') THEN
                           0
                          ELSE
                           TO_NUMBER(PIB_A.VBDEF2)
                        END) VBDEF2,
                    PIB_A.CSOURCEBID
               FROM PO_INVOICE_B PIB_A
              WHERE PIB_A.DR = 0
              GROUP BY PIB_A.CSOURCEBID) PIB
    ON IPIB.CGENERALBID = PIB.CSOURCEBID
  LEFT JOIN (SELECT PAOB_A.PK_ARRIVEORDER, PAOB_A.PK_ARRIVEORDER_B
               FROM PO_ARRIVEORDER_B PAOB_A
              WHERE PAOB_A.DR = 0) PAOB
    ON IPIB.CSOURCEBILLBID = PAOB.PK_ARRIVEORDER_B
  LEFT JOIN PO_ARRIVEORDER PAO
    ON PAO.PK_ARRIVEORDER = PAOB.PK_ARRIVEORDER
  LEFT JOIN (SELECT LMVO_A.NETWEIGHT, LMVO_A.FINALNETWEIGHT, LMVO_A.DEF1
               FROM LM_MTRLSTORVO LMVO_A
              WHERE LMVO_A.DR = 0
                AND LMVO_A.DEF2 = 'Y') LMVO
    ON PAOB.PK_ARRIVEORDER_B = LMVO.DEF1
 WHERE IPIB.DR = 0
   AND BMC.CODE LIKE PARAMETER('mtype') || '%'
   AND IPIH.CVENDORID IN (PARAMETER('supplier'))
   AND OSO.CODE IN (PARAMETER('orgcode'))
   AND OFO.CODE IN (PARAMETER('fincode'))
